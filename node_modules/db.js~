/* debugger */
var log = require("debug");
/* filesystem module */
var fs = require('fs');
/* slug generator */
var slugMod = require('slug');

/* start Base X server */
var sys = require('sys')
var exec = require('child_process').exec;
exec("basexserver -S");

/* create connexion to db */
var basex = require("basex");
basex.debug_mode = false;
var session = new basex.Session("127.0.0.1", 1984, "admin", "admin");
var exportPath = "db";
session.execute("CREATE DB handisport " + exportPath + "/handisport.xml", log.print);


var getSession = function() {
	return session;
}

// fonction qui met à jour la liste (appelée aussi après une insertion, suppression, etc.)
var getList = function(callback) {
	var input = "<liste>{for $sport in doc('handisport')//sport return <sport>{$sport/title}{$sport/slug}</sport> } </liste>";
	var query = session.query(input);

	query.results(function(err, reply) {
		callback(reply.result.join(""));
	});
}

var getSport = function(slug, callback) {	
	var input = 'declare option output:method "xhtml"; ';
	input += "for $sport in doc('handisport')/sports/sport where $sport/slug = '"+ slug +"' return $sport";
	var query = session.query(input);

	query.results(function(err, reply) {
		if(reply.result.length == 0) {
			callback("Ce sport n'existe pas !");
		} else {
			callback(reply.result[0]);
		}
	});
}

var deleteSport = function(slug, callback) {
 	var input = "for $sport in doc('handisport')/sports/sport where $sport/slug = '"+ slug +"' return delete node $sport";
	var query = session.query(input);

	query.results(function(err, reply) {
		session.execute("OPEN handisport", log.print);
		session.execute("EXPORT " + exportPath, log.print);
		callback("Sport bien supprimé.");
	});
}

var updateSport = function(oldSlug, image, sport, callback) {

	if(sport.imgLogo!="" && image.name==""){
		image.name = sport.imgLogo;
	} 

	var errors = [];
	var input = "let $sport := ";
	input += '<sport>';
		if(sport.title){
	    	input += '<title>' + sport.title + '</title>';
	    	input += '<slug>' + slugMod(sport.title) + '</slug>';
	    }	
	    else{ 
	    	errors.push("Titre obligatoire.");
	    }
	    if(sport.description) 
	    	input += '<description>' + sport.description + '</description>';
	    if(sport.link) {
		    input += '<links>';
		  		input += '<link>'+ sport.link +'</link>';
		    input += '</links>';	    	
	    }
	    if(sport.name || sport.manager || sport.address || sport.phone || sport.mail || sport.website || image.name!="") {
		    input += '<clubs>';
		    	input += '<club>';
		    		if(sport.name)
						input += '<name>'+ sport.name +'</name>';
					if(sport.manager)
						input += '<manager>'+ sport.manager +'</manager>';
					if(sport.address)
						input += '<address>'+ sport.address +'</address>';
					if(sport.phone)
						input += '<phone>'+ sport.phone +'</phone>';
					if(sport.mail)
						input += '<mail>'+ sport.mail +'</mail>';
					if(sport.website)
						input += '<website>'+ sport.website +'</website>';
					if(sport.imgLogo!="" || image.type=="image/png" || image.type=="image/jpg" || image.type=="image/jpeg" || image.type=="image/gif")
						input += '<logo>'+ image.name +'</logo>';
					else if (sport.imgLogo=="" && image.name==""){}
					else {errors.push("Mauvaise extension. Seules les images de type png, jpg, gif ou bmp sont autorisées.");}
				input += '</club>';
	    	input += '</clubs>';	    	
	    }
  	input += '</sport>';

  	if(errors.length == 0) {
	  	if(oldSlug) {  	
	  		// modification	
			input += " for $old in doc('handisport')/sports/sport where $old/slug = '"+ oldSlug +"' return replace node $old with $sport";  		
	  	} else {  		
	  		// insertion
	  		input += ' return insert node $sport as last into doc("handisport")/sports';
	  	}  
	  	var query = session.query(input);

		query.results(function(err, reply) {
			session.execute("OPEN handisport", log.print);
			session.execute("EXPORT " + exportPath, log.print);
			callback(false, slugMod(sport.title));
		});
  	} else {
  		callback(true, errors);
  	}	
}

exports.getSession = getSession;

exports.getList = getList;
exports.getSport = getSport;
exports.updateSport = updateSport;
exports.deleteSport = deleteSport;


